<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>tsdst.modeling &#8212; tsdst 1.0.11 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/bootstrap-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html">
          tsdst</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Pages</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
              
                
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <h1>Source code for tsdst.modeling</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span> <span class="k">as</span> <span class="n">copy</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">t</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="p">(</span><span class="n">f1_score</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span>
                             <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="p">(</span><span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">KFold</span><span class="p">,</span>
                                     <span class="n">ShuffleSplit</span><span class="p">,</span> <span class="n">StratifiedShuffleSplit</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">timeit</span> <span class="kn">import</span> <span class="n">default_timer</span> <span class="k">as</span> <span class="n">dt</span>

<span class="kn">from</span> <span class="nn">.metrics</span> <span class="kn">import</span> <span class="p">(</span><span class="n">cox_snell_r2</span><span class="p">,</span> <span class="n">nagelkerke_r2</span><span class="p">,</span> <span class="n">tjur_r2</span><span class="p">,</span> <span class="n">mcfadden_r2</span><span class="p">,</span>
                      <span class="n">conf_mat_metrics</span><span class="p">,</span> <span class="n">bias</span><span class="p">,</span> <span class="n">rpmse</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">adj_r2</span><span class="p">,</span> <span class="n">top_20p</span><span class="p">,</span>
                      <span class="n">number_of_nonzero_coef</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.nn.activations</span> <span class="kn">import</span> <span class="n">sigmoid</span><span class="p">,</span> <span class="n">sigmoid_der</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">reshape_to_vector</span>


<span class="n">DEFAULT_CLASSIFICATION_METRICS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;F1&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;Sens/Recall&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;Specificity&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;PPV&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;NPV&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;AUC&#39;</span>
                                <span class="p">]</span>

<span class="n">DEFAULT_REGRESSION_METRICS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Bias&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;RPMSE&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;R2&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;Adj. R2&#39;</span><span class="p">]</span>


<div class="viewcode-block" id="scoreModel"><a class="viewcode-back" href="../../generated/tsdst.modeling.scoreModel.html#tsdst.modeling.scoreModel">[docs]</a><span class="k">def</span> <span class="nf">scoreModel</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">thres</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mtype</span><span class="o">=</span><span class="s1">&#39;classification&#39;</span><span class="p">,</span>
               <span class="n">print_</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">avg</span><span class="o">=</span><span class="s2">&quot;weighted&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Score a model using the given metrics.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : pandas dataframe</span>
<span class="sd">        Feature or design matrix.</span>
<span class="sd">    Y : pandas series</span>
<span class="sd">        Response or Target variable.</span>
<span class="sd">    model : sklearn, or similar</span>
<span class="sd">        model to fit to the data. Must have fit, predict, and/or predict_proba</span>
<span class="sd">        methods, depending on the metrics.</span>
<span class="sd">    metrics : list, optional</span>
<span class="sd">        The metrics to include in the analysis.</span>
<span class="sd">        The default is [&#39;Accuracy&#39;, &#39;F1&#39;, &#39;Sens/Recall&#39;, &#39;Specificity&#39;, &#39;ppv&#39;, &#39;npv&#39;, &#39;AUC&#39;].</span>
<span class="sd">    thres : float, optional</span>
<span class="sd">        The threshold to use for classification metrics where it might apply.</span>
<span class="sd">        If threshold is None, the default predict method is used (which</span>
<span class="sd">        for most models uses a boundary at or equivalent to 0.5 probability).</span>
<span class="sd">        The default is None.</span>
<span class="sd">    mtype : str, optional</span>
<span class="sd">        The type of model, currently either classification or regression.</span>
<span class="sd">        The default is &#39;classification&#39;.</span>
<span class="sd">    print_ : bool, optional</span>
<span class="sd">        Print progress as applicable. The default is True.</span>
<span class="sd">    avg : str, optional</span>
<span class="sd">        for metrics where it applies, such as AUC, how to calculate the</span>
<span class="sd">        metric (see sklearn docs for more details, particularly with AUC).</span>
<span class="sd">        The default is &#39;weighted&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    res : dict</span>
<span class="sd">        A dictionary containing the results for each metric.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mtype</span> <span class="o">==</span> <span class="s1">&#39;classification&#39;</span><span class="p">:</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="n">DEFAULT_CLASSIFICATION_METRICS</span>
        <span class="k">elif</span> <span class="n">mtype</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="n">DEFAULT_REGRESSION_METRICS</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Metrics must be of mtype `classification` or &#39;</span>
                             <span class="s1">&#39;`regression`&#39;</span><span class="p">)</span>

    <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;average&#39;</span><span class="p">:</span> <span class="n">avg</span><span class="p">,</span>
            <span class="s1">&#39;conf_metric&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X</span><span class="p">,</span>
            <span class="s1">&#39;y_true&#39;</span><span class="p">:</span> <span class="n">Y</span><span class="p">,</span>
            <span class="s1">&#39;y_pred&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;y_score&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;ll_est&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;ll_null&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> 
            <span class="s1">&#39;y_prob_nullmod&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;n_obs&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;rsquared&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;cs_r2&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">model</span><span class="p">}</span>
    <span class="n">All_Metrics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="p">{</span>
                         <span class="s1">&#39;Function&#39;</span><span class="p">:</span> <span class="n">accuracy_score</span><span class="p">,</span>
                         <span class="s1">&#39;arguments&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;y_true&#39;</span><span class="p">,</span> <span class="s1">&#39;y_pred&#39;</span><span class="p">]</span>
                        <span class="p">},</span>
            <span class="s1">&#39;F1&#39;</span><span class="p">:</span> <span class="p">{</span>
                   <span class="s1">&#39;Function&#39;</span><span class="p">:</span> <span class="n">f1_score</span><span class="p">,</span>
                   <span class="s1">&#39;arguments&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;y_true&#39;</span><span class="p">,</span> <span class="s1">&#39;y_pred&#39;</span><span class="p">]</span>
                  <span class="p">},</span>
            <span class="s1">&#39;Sens/Recall&#39;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s1">&#39;Function&#39;</span><span class="p">:</span> <span class="n">conf_mat_metrics</span><span class="p">,</span>
                            <span class="s1">&#39;arguments&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;y_true&#39;</span><span class="p">,</span> <span class="s1">&#39;y_pred&#39;</span><span class="p">,</span> <span class="s1">&#39;conf_metric&#39;</span><span class="p">]</span>
                           <span class="p">},</span>
            <span class="s1">&#39;Specificity&#39;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s1">&#39;Function&#39;</span><span class="p">:</span> <span class="n">conf_mat_metrics</span><span class="p">,</span>
                            <span class="s1">&#39;arguments&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;y_true&#39;</span><span class="p">,</span> <span class="s1">&#39;y_pred&#39;</span><span class="p">,</span> <span class="s1">&#39;conf_metric&#39;</span><span class="p">]</span>
                           <span class="p">},</span>
            <span class="s1">&#39;PPV&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;Function&#39;</span><span class="p">:</span> <span class="n">conf_mat_metrics</span><span class="p">,</span>
                    <span class="s1">&#39;arguments&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;y_true&#39;</span><span class="p">,</span> <span class="s1">&#39;y_pred&#39;</span><span class="p">,</span> <span class="s1">&#39;conf_metric&#39;</span><span class="p">]</span>
                   <span class="p">},</span>
            <span class="s1">&#39;NPV&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;Function&#39;</span><span class="p">:</span> <span class="n">conf_mat_metrics</span><span class="p">,</span>
                    <span class="s1">&#39;arguments&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;y_true&#39;</span><span class="p">,</span> <span class="s1">&#39;y_pred&#39;</span><span class="p">,</span> <span class="s1">&#39;conf_metric&#39;</span><span class="p">]</span>
                   <span class="p">},</span>
            <span class="s1">&#39;Confusion Matrix&#39;</span><span class="p">:</span> <span class="p">{</span>
                         <span class="s1">&#39;Function&#39;</span><span class="p">:</span> <span class="n">conf_mat_metrics</span><span class="p">,</span>
                         <span class="s1">&#39;arguments&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;y_true&#39;</span><span class="p">,</span> <span class="s1">&#39;y_pred&#39;</span><span class="p">,</span> <span class="s1">&#39;conf_metric&#39;</span><span class="p">]</span>
                        <span class="p">},</span>
            <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;Function&#39;</span><span class="p">:</span> <span class="n">roc_auc_score</span><span class="p">,</span>
                    <span class="s1">&#39;arguments&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;y_true&#39;</span><span class="p">,</span> <span class="s1">&#39;y_score&#39;</span><span class="p">,</span> <span class="s1">&#39;average&#39;</span><span class="p">]</span>
                        <span class="p">},</span> 
            <span class="s1">&#39;Cox/Snell R2&#39;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s1">&#39;Function&#39;</span><span class="p">:</span> <span class="n">cox_snell_r2</span><span class="p">,</span>
                            <span class="s1">&#39;arguments&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;ll_est&#39;</span><span class="p">,</span> <span class="s1">&#39;ll_null&#39;</span><span class="p">,</span> <span class="s1">&#39;n_obs&#39;</span><span class="p">]</span>
                        <span class="p">},</span>
            <span class="s1">&#39;McFadden R2&#39;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s1">&#39;Function&#39;</span><span class="p">:</span> <span class="n">mcfadden_r2</span><span class="p">,</span>
                            <span class="s1">&#39;arguments&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;ll_est&#39;</span><span class="p">,</span> <span class="s1">&#39;ll_null&#39;</span><span class="p">]</span>
                        <span class="p">},</span>
            <span class="s1">&#39;Tjur R2&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;Function&#39;</span><span class="p">:</span> <span class="n">tjur_r2</span><span class="p">,</span>
                        <span class="s1">&#39;arguments&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;y_true&#39;</span><span class="p">,</span> <span class="s1">&#39;y_score&#39;</span><span class="p">]</span>
                       <span class="p">},</span>
            <span class="s1">&#39;Nagelkerke R2&#39;</span><span class="p">:</span> <span class="p">{</span>
                              <span class="s1">&#39;Function&#39;</span><span class="p">:</span> <span class="n">nagelkerke_r2</span><span class="p">,</span>
                              <span class="s1">&#39;arguments&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;ll_null&#39;</span><span class="p">,</span> <span class="s1">&#39;n_obs&#39;</span><span class="p">,</span> <span class="s1">&#39;cs_r2&#39;</span><span class="p">,</span> <span class="s1">&#39;ll_est&#39;</span><span class="p">]</span>
                             <span class="p">},</span>
            <span class="s1">&#39;Bias&#39;</span><span class="p">:</span> <span class="p">{</span>
                             <span class="s1">&#39;Function&#39;</span><span class="p">:</span> <span class="n">bias</span><span class="p">,</span>
                             <span class="s1">&#39;arguments&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;y_true&#39;</span><span class="p">,</span> <span class="s1">&#39;y_pred&#39;</span><span class="p">]</span>
                            <span class="p">},</span>
            <span class="s1">&#39;RPMSE&#39;</span><span class="p">:</span> <span class="p">{</span>
                             <span class="s1">&#39;Function&#39;</span><span class="p">:</span> <span class="n">rpmse</span><span class="p">,</span>
                             <span class="s1">&#39;arguments&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;y_true&#39;</span><span class="p">,</span> <span class="s1">&#39;y_pred&#39;</span><span class="p">]</span>
                            <span class="p">},</span>
            <span class="s1">&#39;R2&#39;</span><span class="p">:</span> <span class="p">{</span>
                             <span class="s1">&#39;Function&#39;</span><span class="p">:</span> <span class="n">r2</span><span class="p">,</span>
                             <span class="s1">&#39;arguments&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;y_true&#39;</span><span class="p">,</span> <span class="s1">&#39;y_pred&#39;</span><span class="p">]</span>
                            <span class="p">},</span>
            <span class="s1">&#39;Adj. R2&#39;</span><span class="p">:</span> <span class="p">{</span>
                             <span class="s1">&#39;Function&#39;</span><span class="p">:</span> <span class="n">adj_r2</span><span class="p">,</span>
                             <span class="s1">&#39;arguments&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;y_true&#39;</span><span class="p">,</span> <span class="s1">&#39;y_pred&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;rsquared&#39;</span><span class="p">]</span>
                            <span class="p">},</span>
            <span class="s1">&#39;Top 20%&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;Function&#39;</span><span class="p">:</span> <span class="n">top_20p</span><span class="p">,</span>
                        <span class="s1">&#39;arguments&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;y_true&#39;</span><span class="p">,</span> <span class="s1">&#39;y_score&#39;</span><span class="p">]</span>
            <span class="p">},</span>
            <span class="s1">&#39;Avg Number of Used Features&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;Function&#39;</span><span class="p">:</span> <span class="n">number_of_nonzero_coef</span><span class="p">,</span>
                        <span class="s1">&#39;arguments&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="p">}</span>
    
    <span class="n">y_temp</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">mtype</span> <span class="o">==</span> <span class="s2">&quot;classification&quot;</span><span class="p">:</span>
        
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;n_obs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;y_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">thres</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;y_pred&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;y_pred&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;y_score&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">thres</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">any</span><span class="p">((</span><span class="n">met</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;McFadden R2&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Nagelkerke R2&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Cox/Snell R2&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">met</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">)):</span>
            
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;y_prob_nullmod&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_temp</span><span class="p">),</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;n_obs&#39;</span><span class="p">])</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;ll_est&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_temp</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;y_score&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_temp</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;y_score&#39;</span><span class="p">]))</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;ll_null&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_temp</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;y_prob_nullmod&#39;</span><span class="p">])</span> <span class="o">+</span>
                                     <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_temp</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;y_prob_nullmod&#39;</span><span class="p">]))</span>
                  
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;y_true&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_temp</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;y_pred&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">met</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;conf_metric&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">met</span>
        <span class="n">temp_args</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">args</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">All_Metrics</span><span class="p">[</span><span class="n">met</span><span class="p">][</span><span class="s1">&#39;arguments&#39;</span><span class="p">]}</span>
        <span class="n">res</span><span class="p">[</span><span class="n">met</span><span class="p">]</span> <span class="o">=</span> <span class="n">All_Metrics</span><span class="p">[</span><span class="n">met</span><span class="p">][</span><span class="s1">&#39;Function&#39;</span><span class="p">](</span><span class="o">**</span><span class="n">temp_args</span><span class="p">)</span> 
    
    <span class="k">if</span> <span class="n">print_</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">res</span></div>


<span class="c1"># Currently, this takes just as long as scoreModel and the logic is simpler... keeping for legacy reasons</span>
<span class="k">def</span> <span class="nf">scoreModel_legacy</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">thres</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mtype</span><span class="o">=</span><span class="s1">&#39;classification&#39;</span><span class="p">,</span> <span class="n">print_</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">avg</span><span class="o">=</span><span class="s2">&quot;weighted&quot;</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">mtype</span> <span class="o">==</span> <span class="s2">&quot;classification&quot;</span><span class="p">:</span>
        <span class="n">nobs</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Yprob</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">Yprob_nullmod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">values</span><span class="p">),</span> <span class="n">nobs</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">thres</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Ypred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Ypred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">Yprob</span> <span class="o">&gt;=</span> <span class="n">thres</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">accs</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">Ypred</span><span class="p">)</span>
        <span class="n">f1s</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">Ypred</span><span class="p">)</span>
        <span class="n">aucs</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">Yprob</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="n">avg</span><span class="p">)</span>
        
        <span class="n">ll_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">values</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Yprob</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">Y</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">Yprob</span><span class="p">))</span>
        <span class="n">ll_null</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">values</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Yprob_nullmod</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">Y</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">Yprob_nullmod</span><span class="p">))</span>
        
        <span class="c1"># Cox Snell R2</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="mi">2</span><span class="o">/</span><span class="n">nobs</span>
        <span class="n">cs_r2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">ratio</span><span class="o">*</span><span class="p">(</span><span class="n">ll_null</span> <span class="o">-</span> <span class="n">ll_est</span><span class="p">))</span>
        <span class="n">r2_max</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">ratio</span><span class="o">*</span><span class="n">ll_null</span><span class="p">)</span>

        <span class="c1"># Correction to CS R2 to bound between 0, 1</span>
        <span class="n">n_r2</span> <span class="o">=</span> <span class="n">cs_r2</span><span class="o">/</span><span class="n">r2_max</span>
        
        <span class="c1"># When the saturated model is not available (common), then</span>
        <span class="c1"># Mcfaddens R2 is equivalent to the likelihood ratio r2</span>
        <span class="n">m_r2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">ll_est</span><span class="o">/</span><span class="n">ll_null</span><span class="p">)</span>
        
        <span class="c1">#Tjur R2</span>
        <span class="n">y_mu1</span> <span class="o">=</span> <span class="n">Yprob</span><span class="p">[</span><span class="n">Y</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">y_mu0</span> <span class="o">=</span> <span class="n">Yprob</span><span class="p">[</span><span class="n">Y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">t_r2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_mu1</span> <span class="o">-</span> <span class="n">y_mu0</span><span class="p">)</span>

        <span class="c1"># Assumes 1 as the positive class</span>
        <span class="n">confmat</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">Ypred</span><span class="p">)</span>
        <span class="n">tn</span> <span class="o">=</span> <span class="n">confmat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">tp</span> <span class="o">=</span> <span class="n">confmat</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">confmat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">confmat</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">tnfp</span> <span class="o">=</span> <span class="n">tn</span> <span class="o">+</span> <span class="n">fp</span>
        <span class="n">tpfn</span> <span class="o">=</span> <span class="n">tp</span> <span class="o">+</span> <span class="n">fn</span>
        <span class="n">tpfp</span> <span class="o">=</span> <span class="n">tp</span> <span class="o">+</span> <span class="n">fp</span>
        <span class="n">tnfn</span> <span class="o">=</span> <span class="n">tn</span> <span class="o">+</span> <span class="n">fn</span>
        <span class="k">if</span> <span class="n">tnfp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="n">tn</span><span class="o">/</span><span class="n">tnfp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">tpfn</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sens</span> <span class="o">=</span> <span class="n">tp</span><span class="o">/</span><span class="n">tpfn</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sens</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">tpfp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ppv</span> <span class="o">=</span> <span class="n">tp</span><span class="o">/</span><span class="n">tpfp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ppv</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">tnfn</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">npv</span> <span class="o">=</span> <span class="n">tn</span><span class="o">/</span><span class="n">tnfn</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">npv</span> <span class="o">=</span> <span class="mi">0</span>
            
        <span class="k">if</span> <span class="n">print_</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Accuracy       : &quot;</span><span class="p">,</span> <span class="n">accs</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;F1             : &quot;</span><span class="p">,</span> <span class="n">f1s</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sens/Recall    : &quot;</span><span class="p">,</span> <span class="n">sens</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Specificity     : &quot;</span><span class="p">,</span> <span class="n">spec</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pos Prev Val   : &quot;</span><span class="p">,</span> <span class="n">ppv</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Neg Prev Val   : &quot;</span><span class="p">,</span> <span class="n">npv</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AUC            : &quot;</span><span class="p">,</span> <span class="n">aucs</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;R2 (McFadden)  : &quot;</span><span class="p">,</span> <span class="n">m_r2</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;R2 (Tjur)      : &quot;</span><span class="p">,</span> <span class="n">t_r2</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;R2 (Nagelkerke): &quot;</span><span class="p">,</span> <span class="n">n_r2</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;R2 (Cox/Snell) : &quot;</span><span class="p">,</span> <span class="n">cs_r2</span><span class="p">)</span>
    
        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">accs</span><span class="p">,</span>
            <span class="s1">&#39;F1&#39;</span><span class="p">:</span> <span class="n">f1s</span><span class="p">,</span>
            <span class="s1">&#39;Sens/Recall&#39;</span><span class="p">:</span> <span class="n">sens</span><span class="p">,</span>
            <span class="s1">&#39;Specificity&#39;</span><span class="p">:</span> <span class="n">spec</span><span class="p">,</span>
            <span class="s1">&#39;ppv&#39;</span><span class="p">:</span> <span class="n">ppv</span><span class="p">,</span>
            <span class="s1">&#39;npv&#39;</span><span class="p">:</span> <span class="n">npv</span><span class="p">,</span>
            <span class="s1">&#39;Conf_Mat&#39;</span><span class="p">:</span> <span class="n">confmat</span><span class="p">,</span>
            <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">aucs</span><span class="p">,</span>
            <span class="s1">&#39;McFadden R2&#39;</span><span class="p">:</span> <span class="n">m_r2</span><span class="p">,</span>
            <span class="s1">&#39;Tjur R2&#39;</span><span class="p">:</span> <span class="n">t_r2</span><span class="p">,</span>
            <span class="s1">&#39;Nagelkerke R2&#39;</span><span class="p">:</span> <span class="n">n_r2</span><span class="p">,</span>
            <span class="s1">&#39;Cox/Snell R2&#39;</span><span class="p">:</span> <span class="n">cs_r2</span>
        <span class="p">}</span>
                  
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Ypred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">Ydiff</span> <span class="o">=</span> <span class="n">Ypred</span> <span class="o">-</span> <span class="n">Y</span><span class="o">.</span><span class="n">values</span>
        <span class="n">Ybar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        
        <span class="n">bias</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Ydiff</span><span class="p">)</span>
        <span class="n">rpmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Ydiff</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">SST</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">Y</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">Ybar</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># SSE = np.sum((Y.values - Ypred)**2)</span>
        <span class="n">SSR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">Ypred</span> <span class="o">-</span> <span class="n">Ybar</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># also equal to 1 - SSE/SST</span>
        <span class="c1"># alternative R2: np.corrcoef((ypred, ytrue))**2</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="n">SSR</span><span class="o">/</span><span class="n">SST</span>
        <span class="n">adj_r2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">r2</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">print_</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Bias       : &quot;</span><span class="p">,</span> <span class="n">bias</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RPMSE      : &quot;</span><span class="p">,</span> <span class="n">rpmse</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;R2         : &quot;</span><span class="p">,</span> <span class="n">r2</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Adj. R2    : &quot;</span><span class="p">,</span> <span class="n">adj_r2</span><span class="p">)</span>
    
        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Bias&#39;</span><span class="p">:</span> <span class="n">bias</span><span class="p">,</span>
            <span class="s1">&#39;RPMSE&#39;</span><span class="p">:</span> <span class="n">rpmse</span><span class="p">,</span>
            <span class="s1">&#39;R2&#39;</span><span class="p">:</span> <span class="n">r2</span><span class="p">,</span>
            <span class="s1">&#39;Adj. R2&#39;</span><span class="p">:</span> <span class="n">adj_r2</span>
        <span class="p">}</span>
        
    <span class="k">return</span> <span class="n">res</span>


<div class="viewcode-block" id="runScorers"><a class="viewcode-back" href="../../generated/tsdst.modeling.runScorers.html#tsdst.modeling.runScorers">[docs]</a><span class="k">def</span> <span class="nf">runScorers</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">splits</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">avg</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">,</span> <span class="n">calculate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">method_on_X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mox_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Y_for_test_only</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">sample_limit</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Performs the cross-validation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : pandas dataframe</span>
<span class="sd">        Feature or design matrix.</span>
<span class="sd">    Y : pandas series</span>
<span class="sd">        Response or Target variable.</span>
<span class="sd">    splits : sklearn.model_selection object</span>
<span class="sd">        Contains the split type and information about the split.</span>
<span class="sd">    model : sklearn, or similar</span>
<span class="sd">        model to fit to the data. Must have fit, predict, and/or predict_proba</span>
<span class="sd">        methods, depending on the metrics.</span>
<span class="sd">    mtype : str, optional</span>
<span class="sd">        The type of model, currently either classification or regressor.</span>
<span class="sd">        The default is &#39;classification&#39;.</span>
<span class="sd">    metrics : list, optional</span>
<span class="sd">        The metrics to include in the analysis.</span>
<span class="sd">        The default is [&#39;Accuracy&#39;, &#39;F1&#39;, &#39;Sens/Recall&#39;, \</span>
<span class="sd">                        &#39;Specificity&#39;, &#39;ppv&#39;, &#39;npv&#39;, &#39;AUC&#39;].</span>
<span class="sd">    avg : str, optional</span>
<span class="sd">        for metrics where it applies, such as AUC, how to calculate the</span>
<span class="sd">        metric (see sklearn docs for more details, particularly with AUC).</span>
<span class="sd">        The default is &quot;weighted&quot;.</span>
<span class="sd">    calculate : list or str, optional</span>
<span class="sd">        What to calculate the metrics on, either in-sample or out-of-sample,</span>
<span class="sd">        or both. In-sample measures the metrics on the train set while</span>
<span class="sd">        out-of-sample measures on the test set.</span>
<span class="sd">        The default is [&#39;Out of Sample&#39;].</span>
<span class="sd">    method_on_X : function, optional</span>
<span class="sd">        An optional function to pass that performs an operation on X.</span>
<span class="sd">        For example, you could pass a function to perform PCA before</span>
<span class="sd">        performing the fits. This would enable the function to be applied to</span>
<span class="sd">        each level of split. The method used to transform/modify X can be</span>
<span class="sd">        of any class, the only requirement is that it has both fit and</span>
<span class="sd">        transform methods, and that the arguments for fit method accept both</span>
<span class="sd">        an X and Y argument, even if the Y argument does nothing. You may need</span>
<span class="sd">        to create a simple wrapper for this, if you have a known method you </span>
<span class="sd">        want to use, but doesn&#39;t quite fit what you need. The default is None.</span>
<span class="sd">    mox_args : dict, optional</span>
<span class="sd">        Any optional arguments that get passed to the constructor of the</span>
<span class="sd">        method_on_X. The default is None.</span>
<span class="sd">    Y_for_test_only : pandas series or numpy array, optional</span>
<span class="sd">        An alternate target variable to test on, mainly for the use case of</span>
<span class="sd">        training on one response (perhaps one that is more informative or</span>
<span class="sd">        restrictive), but then predicting on a separate test set.</span>
<span class="sd">        The default is None.</span>
<span class="sd">    sample_limit : int, optional</span>
<span class="sd">        The minimum acceptable samples in a split for the response</span>
<span class="sd">        variable. Only applies to Y_for_test_only currently.</span>
<span class="sd">        The default is 20.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    keys : dict</span>
<span class="sd">        A dictionary containing the results.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">DEFAULT_METRICS</span>
    <span class="k">if</span> <span class="n">calculate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">calculate</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Out of Sample&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">mox_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mox_args</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="p">{}</span>
 
    <span class="k">for</span> <span class="n">train_idx</span><span class="p">,</span> <span class="n">test_idx</span> <span class="ow">in</span> <span class="n">splits</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
        <span class="n">Xtrain</span><span class="p">,</span> <span class="n">Xtest</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_idx</span><span class="p">]</span>
        <span class="n">Ytrain</span><span class="p">,</span> <span class="n">Ytest</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span> <span class="n">Y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_idx</span><span class="p">]</span>
        <span class="c1"># Adding a note so I don&#39;t forget what this is for... </span>
        <span class="c1"># This is for the situation where you want to train on one definition of truth</span>
        <span class="c1"># but test on another, for example, train on the definition where a positive case</span>
        <span class="c1"># is either a revoke or a deny, but test on the definition where a positive case</span>
        <span class="c1"># is only revoked </span>
        <span class="k">if</span> <span class="n">Y_for_test_only</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_Ytest</span> <span class="o">=</span> <span class="n">Y_for_test_only</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_idx</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">mtype</span> <span class="o">==</span> <span class="s1">&#39;classification&#39;</span><span class="p">:</span>
                <span class="n">classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">new_Ytest</span><span class="p">)</span>
                <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">new_Ytest</span><span class="p">[</span><span class="n">new_Ytest</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">counts</span> <span class="o">&gt;=</span> <span class="n">sample_limit</span><span class="p">):</span>
                    <span class="n">Ytest</span> <span class="o">=</span> <span class="n">new_Ytest</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Not all classes have at least </span><span class="si">%d</span><span class="s2"> samples. Using default test set&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sample_limit</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Ytest</span> <span class="o">=</span> <span class="n">new_Ytest</span>
        
        <span class="c1"># Method on X must return a dataframe in your method</span>
        <span class="c1"># on X function, set Y=None as a default argument</span>
        <span class="c1"># and let it pass through if not needed</span>
        <span class="k">if</span> <span class="n">method_on_X</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">method_fit</span> <span class="o">=</span> <span class="n">method_on_X</span><span class="p">(</span><span class="o">**</span><span class="n">mox_args</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Xtrain</span><span class="p">,</span> <span class="n">Ytrain</span><span class="p">)</span>
            <span class="n">Xtrain</span> <span class="o">=</span> <span class="n">method_fit</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">Xtrain</span><span class="p">)</span>
            <span class="n">Xtest</span> <span class="o">=</span> <span class="n">method_fit</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">Xtest</span><span class="p">)</span>
        
        <span class="n">mod</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Xtrain</span><span class="p">,</span> <span class="n">Ytrain</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>

        <span class="n">score</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sk</span> <span class="ow">in</span> <span class="n">calculate</span><span class="p">:</span>
                <span class="n">keys</span><span class="p">[</span><span class="n">sk</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">sk</span> <span class="o">==</span> <span class="s1">&#39;Out of Sample&#39;</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="n">scoreModel</span><span class="p">(</span><span class="n">Xtest</span><span class="p">,</span> <span class="n">Ytest</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span>
                                       <span class="n">mtype</span><span class="o">=</span><span class="n">mtype</span><span class="p">,</span> <span class="n">print_</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">avg</span><span class="o">=</span><span class="n">avg</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">sk</span> <span class="o">==</span> <span class="s1">&#39;In Sample&#39;</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="n">scoreModel</span><span class="p">(</span><span class="n">Xtrain</span><span class="p">,</span> <span class="n">Ytrain</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span>
                                       <span class="n">mtype</span><span class="o">=</span><span class="n">mtype</span><span class="p">,</span> <span class="n">print_</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">avg</span><span class="o">=</span><span class="n">avg</span><span class="p">)</span>
                    
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">score</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">keys</span><span class="p">[</span><span class="n">sk</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">score</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sk</span> <span class="ow">in</span> <span class="n">calculate</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sk</span> <span class="o">==</span> <span class="s1">&#39;Out of Sample&#39;</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="n">scoreModel</span><span class="p">(</span><span class="n">Xtest</span><span class="p">,</span> <span class="n">Ytest</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span>
                                       <span class="n">mtype</span><span class="o">=</span><span class="n">mtype</span><span class="p">,</span> <span class="n">print_</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">avg</span><span class="o">=</span><span class="n">avg</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">sk</span> <span class="o">==</span> <span class="s1">&#39;In Sample&#39;</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="n">scoreModel</span><span class="p">(</span><span class="n">Xtrain</span><span class="p">,</span> <span class="n">Ytrain</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span>
                                       <span class="n">mtype</span><span class="o">=</span><span class="n">mtype</span><span class="p">,</span> <span class="n">print_</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">avg</span><span class="o">=</span><span class="n">avg</span><span class="p">)</span>
                    
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">score</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">keys</span><span class="p">[</span><span class="n">sk</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">keys</span></div>


<div class="viewcode-block" id="printScores"><a class="viewcode-back" href="../../generated/tsdst.modeling.printScores.html#tsdst.modeling.printScores">[docs]</a><span class="k">def</span> <span class="nf">printScores</span><span class="p">(</span><span class="n">scores</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A helper function to print the outputs of the crossVal function.</span>

<span class="sd">    Currently, it does not print confusion matrices.    </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    scores : dict</span>
<span class="sd">        The dictionary of scores.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">longest_key</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">scores</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">score_type</span> <span class="ow">in</span> <span class="n">scores</span><span class="p">[</span><span class="n">sample</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">score_type</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">longest_key</span><span class="p">:</span>
                <span class="n">longest_key</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">score_type</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">scores</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="s2">&quot;: &quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">score_type</span> <span class="ow">in</span> <span class="n">scores</span><span class="p">[</span><span class="n">sample</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="n">sample</span><span class="p">][</span><span class="n">score_type</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">score_type</span> <span class="o">==</span> <span class="s1">&#39;Conf_Mat&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">spacer</span> <span class="o">=</span> <span class="n">longest_key</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">score_type</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">score_type</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="o">*</span><span class="n">spacer</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\u03BC</span><span class="s1">: &#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">values</span><span class="p">)),</span> <span class="s1">&#39;, &#39;</span><span class="p">,</span>
                      <span class="s1">&#39;</span><span class="se">\u03C3</span><span class="s1">: &#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span> <span class="s1">&#39;, &#39;</span><span class="p">,</span>
                      <span class="s1">&#39;2</span><span class="se">\u03C3</span><span class="s1"> Interval (&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">))),</span> <span class="s1">&#39;, &#39;</span><span class="p">,</span>
                      <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">))),</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span>
                      <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span></div>

        
<div class="viewcode-block" id="crossVal"><a class="viewcode-back" href="../../generated/tsdst.modeling.crossVal.html#tsdst.modeling.crossVal">[docs]</a><span class="k">def</span> <span class="nf">crossVal</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">cv_iterations</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;k-fold&#39;</span><span class="p">,</span>
             <span class="n">mtype</span><span class="o">=</span><span class="s1">&#39;classification&#39;</span><span class="p">,</span> <span class="n">stratified</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">print_</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">random_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method_on_X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mox_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">avg</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
             <span class="n">calculate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">Y_for_test_only</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sample_limit</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="c1"># TODO: add parallel support</span>
    <span class="sd">&quot;&quot;&quot;A custom cross-validation strategy. While sklearn has a lot of beefed up</span>
<span class="sd">    functionality regarding cross-validation strategies, I like this one</span>
<span class="sd">    because it puts most of the strategies I like to use in one place. Also,</span>
<span class="sd">    it allows for you to output and calculate several cross-validation metrics</span>
<span class="sd">    at once.</span>
<span class="sd">    </span>
<span class="sd">    One thing that still needs to be added here is parallelization, since each</span>
<span class="sd">    of the folds can be calculated simultaneously.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : pandas dataframe</span>
<span class="sd">        Feature or design marix.</span>
<span class="sd">    Y : pandas series</span>
<span class="sd">        Response or Target variable.</span>
<span class="sd">    cv_iterations : int</span>
<span class="sd">        The number of cross validation iterations. For k-fold, it is the</span>
<span class="sd">        number of folds, and for shuffle, it is the number of iterations.</span>
<span class="sd">    model : sklearn, or similar</span>
<span class="sd">        model to fit to the data. Must have fit, predict, and/or predict_proba</span>
<span class="sd">        methods, depending on the metrics.</span>
<span class="sd">    method : str, optional</span>
<span class="sd">        The method of cross-validation, either k-fold or shuffle.</span>
<span class="sd">        The default is &#39;k-fold&#39;.</span>
<span class="sd">    mtype : str, optional</span>
<span class="sd">        The type of model, currently either classification or regressor.</span>
<span class="sd">        The default is &#39;classification&#39;.</span>
<span class="sd">    stratified : bool, optional</span>
<span class="sd">        Use a stratified sample instead of a random sample.</span>
<span class="sd">        The default is True.</span>
<span class="sd">    print_ : bool, optional</span>
<span class="sd">        Print the results along the way. The default is True.</span>
<span class="sd">    random_state : int, optional</span>
<span class="sd">        Set the random seed for reproducibility. The default is None.</span>
<span class="sd">    method_on_X : function, optional</span>
<span class="sd">        An optional function to pass that performs an operation on X.</span>
<span class="sd">        For example, you could pass a function to perform PCA before</span>
<span class="sd">        performing the fits. This would enable the function to be applied to</span>
<span class="sd">        each level of split. The method used to transform/modify X can be</span>
<span class="sd">        of any class, the only requirement is that it has both fit and</span>
<span class="sd">        transform methods, and that the arguments for fit method accept both</span>
<span class="sd">        an X and Y argument, even if the Y argument does nothing. You may need</span>
<span class="sd">        to create a simple wrapper for this, if you have a known method you </span>
<span class="sd">        want to use, but doesn&#39;t quite fit what you need. The default is None.</span>
<span class="sd">    mox_args : dict, optional</span>
<span class="sd">        Any optional arguments that get passed to the constructor of the</span>
<span class="sd">        method_on_X. The default is {}.</span>
<span class="sd">    avg : str, optional</span>
<span class="sd">        for metrics where it applies, such as AUC, how to calculate the</span>
<span class="sd">        metric (see sklearn docs for more details, particularily with AUC).</span>
<span class="sd">        The default is &quot;weighted&quot;.</span>
<span class="sd">    shuffle : bool, optional</span>
<span class="sd">        Shuffle the dataset in the k-fold operations. The default is True.</span>
<span class="sd">    test_size : float, optional</span>
<span class="sd">        A percent representing the size of the test set. The default is 0.1.</span>
<span class="sd">    calculate : list or str, optional</span>
<span class="sd">        What to calculate the metrics on, either in-sample or out-of-sample,</span>
<span class="sd">        or both. In-sample measures the metrics on the train set while</span>
<span class="sd">        out-of-sample measures on the test set.</span>
<span class="sd">        The default is [&#39;Out of Sample&#39;].</span>
<span class="sd">    metrics : list, optional</span>
<span class="sd">        The metrics to include in the analysis.</span>
<span class="sd">        The default is [&#39;Accuracy&#39;, &#39;F1&#39;, &#39;Sens/Recall&#39;, &#39;Specificity&#39;, &#39;ppv&#39;, &#39;npv&#39;, &#39;AUC&#39;].</span>
<span class="sd">    Y_for_test_only : pandas series or numpy array, optional</span>
<span class="sd">        An alternate target variable to test on, mainly for the use case of</span>
<span class="sd">        training on one response (perhaps one that is more informative or</span>
<span class="sd">        restrictive), but then predicting on a separate test set.</span>
<span class="sd">        The default is None.</span>
<span class="sd">    sample_limit : int, optional</span>
<span class="sd">        The minimum acceptable samples in a split for the response</span>
<span class="sd">        variable. Only applies to Y_for_test_only currently.</span>
<span class="sd">        The default is 20.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    scores : dict</span>
<span class="sd">        Dictionary of performance metrics.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; import pandas as pd</span>
<span class="sd">    &gt;&gt;&gt; import seaborn as sns</span>
<span class="sd">    &gt;&gt;&gt; from matplotlib import pyplot as plt</span>
<span class="sd">    &gt;&gt;&gt; from sklearn.datasets import make_classification</span>
<span class="sd">    &gt;&gt;&gt; from sklearn.linear_model import LogisticRegression</span>
<span class="sd">    &gt;&gt;&gt; from sklearn.model_selection import train_test_split</span>
<span class="sd">    &gt;&gt;&gt; from timeit import default_timer as dt</span>
<span class="sd">    &gt;&gt;&gt; </span>
<span class="sd">    &gt;&gt;&gt; from tsdst.modeling import crossVal</span>
<span class="sd">    &gt;&gt;&gt; </span>
<span class="sd">    &gt;&gt;&gt; X, y = make_classification(n_samples=10000, n_features=50, flip_y=0.2, random_state=42)</span>
<span class="sd">    &gt;&gt;&gt; X = pd.DataFrame(X, columns=[&#39;V&#39; + str(i) for i in range(X.shape[1])])</span>
<span class="sd">    &gt;&gt;&gt; y = pd.DataFrame(y.reshape(-1, 1), columns=[&#39;y&#39;])</span>
<span class="sd">    &gt;&gt;&gt; </span>
<span class="sd">    &gt;&gt;&gt; X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)</span>
<span class="sd">    &gt;&gt;&gt; </span>
<span class="sd">    &gt;&gt;&gt; sk_mod = LogisticRegression()</span>
<span class="sd">    &gt;&gt;&gt; </span>
<span class="sd">    &gt;&gt;&gt; results = crossVal(X_train, y_train, 5, sk_mod)</span>
<span class="sd">    Out of Sample:</span>
<span class="sd">        Accuracy   : : 0.8155, : 0.0052, 2 Interval (0.8051, 0.8259)</span>
<span class="sd">        F1         : : 0.8151, : 0.0048, 2 Interval (0.8056, 0.8246)</span>
<span class="sd">        Sens/Recall: : 0.8184, : 0.0105, 2 Interval (0.7973, 0.8394)</span>
<span class="sd">        Specificity: : 0.8129, : 0.0063, 2 Interval (0.8002, 0.8256)</span>
<span class="sd">        ppv        : : 0.8121, : 0.0095, 2 Interval (0.7930, 0.8312)</span>
<span class="sd">        npv        : : 0.8189, : 0.0138, 2 Interval (0.7914, 0.8464)</span>
<span class="sd">        AUC        : : 0.8637, : 0.0066, 2 Interval (0.8505, 0.8769)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">mox_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mox_args</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">DEFAULT_METRICS</span>
    <span class="k">if</span> <span class="n">calculate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">calculate</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Out of Sample&#39;</span><span class="p">]</span>

    <span class="n">splits</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">mtype</span> <span class="o">!=</span> <span class="s1">&#39;classification&#39;</span><span class="p">:</span>
        <span class="n">stratified</span> <span class="o">=</span> <span class="kc">False</span>
        
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;k-fold&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">stratified</span><span class="p">:</span>
            <span class="n">splits</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">cv_iterations</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span>
                                     <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">splits</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="n">cv_iterations</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span>
                           <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">stratified</span><span class="p">:</span>
            <span class="n">splits</span> <span class="o">=</span> <span class="n">StratifiedShuffleSplit</span><span class="p">(</span><span class="n">cv_iterations</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="n">test_size</span><span class="p">,</span>
                                            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">splits</span> <span class="o">=</span> <span class="n">ShuffleSplit</span><span class="p">(</span><span class="n">cv_iterations</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="n">test_size</span><span class="p">,</span>
                                  <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>

    <span class="n">scores</span> <span class="o">=</span> <span class="n">runScorers</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">splits</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span> <span class="n">avg</span><span class="o">=</span><span class="n">avg</span><span class="p">,</span>
                        <span class="n">calculate</span><span class="o">=</span><span class="n">calculate</span><span class="p">,</span> <span class="n">method_on_X</span><span class="o">=</span><span class="n">method_on_X</span><span class="p">,</span>
                        <span class="n">mox_args</span><span class="o">=</span><span class="n">mox_args</span><span class="p">,</span> <span class="n">Y_for_test_only</span><span class="o">=</span><span class="n">Y_for_test_only</span><span class="p">,</span>
                        <span class="n">sample_limit</span><span class="o">=</span><span class="n">sample_limit</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">print_</span><span class="p">:</span>
        <span class="n">printScores</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
            
    <span class="k">return</span> <span class="n">scores</span></div>


<span class="c1"># labels is a dictionary identifying what the label values should be,</span>
<span class="c1"># where the dictionary key is the new label, and the dictionary value</span>
<span class="c1"># is the current class value</span>
<div class="viewcode-block" id="prettyConfMat"><a class="viewcode-back" href="../../generated/tsdst.modeling.prettyConfMat.html#tsdst.modeling.prettyConfMat">[docs]</a><span class="k">def</span> <span class="nf">prettyConfMat</span><span class="p">(</span><span class="n">Ytrue</span><span class="p">,</span> <span class="n">Ypred</span><span class="p">,</span>
                  <span class="n">print_</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">margins</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Print a pretty confusion matrix.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Ytrue : numpy array or pandas series</span>
<span class="sd">        The true class values.</span>
<span class="sd">    Ypred : numpy array or pandas series</span>
<span class="sd">        The predicted class values.</span>
<span class="sd">    print_ : bool, optional</span>
<span class="sd">        Print the confusion matrix at the end. The default is True.</span>
<span class="sd">    margins : bool, optional</span>
<span class="sd">        Include the summed margins in the matrix. The default is True.</span>
<span class="sd">    labels : dict, optional</span>
<span class="sd">        A dictionary of key-value pairs, where the keys are the labels,</span>
<span class="sd">        and the values are the class values in Ytrue. class labels for the</span>
<span class="sd">        confusion matrix. The default is None.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    KeyError</span>
<span class="sd">        If labels are provided, an error is raised if the size of the array</span>
<span class="sd">        containing the labels does not match the number of possible classes.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    confmat : pandas dataframe</span>
<span class="sd">        A dataframe containing the confusion matrix.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Ytrue</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Ytrue</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
            <span class="n">Ytrue</span> <span class="o">=</span> <span class="n">Ytrue</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Ypred</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Ypred</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
            <span class="n">Ypred</span> <span class="o">=</span> <span class="n">Ypred</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
        <span class="n">maxlen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">Ytrue</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">!=</span> <span class="n">maxlen</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Incorrect number of labels compared to truth label values&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Ytrue</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">Ytrue_label</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
            <span class="n">Ypred_label</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">lab</span> <span class="ow">in</span> <span class="n">labels</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">Ytrue_label</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">Ytrue</span> <span class="o">==</span> <span class="n">labels</span><span class="p">[</span><span class="n">lab</span><span class="p">]]</span> <span class="o">=</span> <span class="n">lab</span>
                <span class="n">Ypred_label</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">Ypred</span> <span class="o">==</span> <span class="n">labels</span><span class="p">[</span><span class="n">lab</span><span class="p">]]</span> <span class="o">=</span> <span class="n">lab</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Ytrue_label</span> <span class="o">=</span> <span class="n">Ytrue</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">Ypred_label</span> <span class="o">=</span> <span class="n">Ypred</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="n">cm_vals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">(</span><span class="n">Ytrue_label</span><span class="p">,</span> <span class="n">Ypred_label</span><span class="p">,</span> <span class="n">margins</span><span class="o">=</span><span class="n">margins</span><span class="p">,</span> <span class="n">margins_name</span><span class="o">=</span><span class="s1">&#39;Total&#39;</span><span class="p">)</span>

    <span class="n">rowcolkeys</span> <span class="o">=</span> <span class="p">[</span><span class="n">lab</span> <span class="k">for</span> <span class="n">lab</span> <span class="ow">in</span> <span class="n">labels</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Total&#39;</span><span class="p">]</span>
    <span class="n">cm_vals</span> <span class="o">=</span> <span class="n">cm_vals</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">rowcolkeys</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">cm_vals</span> <span class="o">=</span> <span class="n">cm_vals</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">rowcolkeys</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">rownames</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([[</span><span class="s1">&#39;Actual&#39;</span><span class="p">],</span> <span class="n">rowcolkeys</span><span class="p">])</span>
    <span class="n">colnames</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([[</span><span class="s1">&#39;Predicted&#39;</span><span class="p">],</span> <span class="n">rowcolkeys</span><span class="p">])</span>
    <span class="c1">#confmat = cm_vals.reindex(pd.MultiIndex.from_product([[&#39;Actual&#39;], [lab for lab in labels.keys()] + [&#39;All&#39;]]))</span>
    <span class="n">confmat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cm_vals</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">rownames</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">colnames</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">print_</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">confmat</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">confmat</span></div>

  
<span class="k">def</span> <span class="nf">GenerateRegCov</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">fit_mod</span><span class="p">,</span> <span class="n">logit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lamda</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate the covariance matrix for regression parameters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : pandas dataframe</span>
<span class="sd">        The feature or design matrix.</span>
<span class="sd">    Y : pandas series or numpy array</span>
<span class="sd">        The response or target variable.</span>
<span class="sd">    fit_mod : sklearn model, or similar</span>
<span class="sd">        The fitted model (Logistic or linear Regression).</span>
<span class="sd">    logit : bool, optional</span>
<span class="sd">        If True, calculate Logistic Regression SE, otherwise, Linear. Default is True</span>
<span class="sd">    low_memory : bool, optional</span>
<span class="sd">        Sometimes this process uses a lot of memory. If True, calculate using less memory.</span>
<span class="sd">        The default is False.</span>
<span class="sd">    lamda : float, optional</span>
<span class="sd">        If performing ridge regression, this is the penalty term, lambda.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    cov : numpy array</span>
<span class="sd">        The covariance matrix for regression parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Xc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">X</span><span class="p">])</span>
    <span class="n">sigma2</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">XtX_inv</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">logit</span><span class="p">:</span>
        <span class="n">Yprob</span> <span class="o">=</span> <span class="n">fit_mod</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="c1"># p*(1-p), or pq (also V)</span>
        <span class="n">Yprob_prod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">Yprob</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">low_memory</span><span class="p">:</span>
            <span class="n">XV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">Xc</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">XV</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xc</span><span class="o">.</span><span class="n">T</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">Yprob_prod</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">XVXt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">XV</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">XV</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">XVXt</span> <span class="o">=</span> <span class="n">XV</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Xc</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">MemoryError</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">XV</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">XV</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="n">sumprod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">XV</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">Xc</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]))</span>
                        <span class="n">XVXt</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">sumprod</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># cov of logit</span>
            <span class="n">XVXt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Xc</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">diagflat</span><span class="p">(</span><span class="n">Yprob_prod</span><span class="p">)),</span> <span class="n">Xc</span><span class="p">)</span>
            <span class="c1"># Note: The above is only correct if assumptions are true. If assumptions </span>
            <span class="c1"># are violated (i.e. Y does not follow bernoulli, not monotonic probability,</span>
            <span class="c1"># etc., then another robust formulation we could use is:</span>
            <span class="c1">#     XVXt = np.dot(np.dot(Xc.T, np.diagflat(V)), Xc)</span>
            <span class="c1">#     XVXt_inv = np.linalg.inv(XVXt)</span>
            <span class="c1">#     cov = XVXt_inv.dot(XVXt).dot(XVXt_inv)</span>
            <span class="c1"># where V is not Yprob_prob, but:</span>
            <span class="c1">#     V = np.diagflat(Y - Yprob[:, 1])</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">XVXt</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># could use model.predict instead of Xc.dot(betas), but it&#39;s a good</span>
        <span class="c1"># reminder of the math</span>
        <span class="n">betas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">fit_mod</span><span class="o">.</span><span class="n">intercept_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,),</span>
                                <span class="n">fit_mod</span><span class="o">.</span><span class="n">coef_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># This is mean squared error with a specified number of standard</span>
        <span class="c1"># deviations, i.e. the standard deviation of the residuals for n-p</span>
        <span class="c1"># degrees of freedom rather than n-1 (the typical unbiased estimator)</span>
        <span class="c1"># or n (the biased MLE esimator)</span>
        <span class="c1">#</span>
        <span class="c1"># This unbiased estimate for sigma is called the &#39;squared residual standard error&#39;</span>
        <span class="c1"># In matrix notation (where p includes intercept), sigma2 = (1/(n-p))*((y-XB)^T *dot* (y-XB))</span>
        <span class="c1"># and sigma2_mle = (1/n)*((y-XB)^T *dot* (y-XB))</span>
        <span class="n">sigma2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">Y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">Xc</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">betas</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">Xc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">betas</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">lamda</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># ridge regression case</span>
            <span class="n">Xt_X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Xc</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Xc</span><span class="p">)</span>
            <span class="n">xt_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Xt_X</span> <span class="o">+</span> <span class="n">lamda</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">Xt_X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="c1"># example of a &quot;sandwich&quot; estimator</span>
            <span class="n">XtX_inv</span> <span class="o">=</span> <span class="n">xt_inv</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Xt_X</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">xt_inv</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">XtX_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Xc</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Xc</span><span class="p">))</span>
        <span class="c1"># var(beta_hat) = diag(cov)</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="n">sigma2</span><span class="o">*</span><span class="n">XtX_inv</span>
    <span class="k">return</span> <span class="n">cov</span><span class="p">,</span> <span class="n">XtX_inv</span><span class="p">,</span> <span class="n">sigma2</span><span class="p">,</span> <span class="n">betas</span>
  

<div class="viewcode-block" id="RegressionSE"><a class="viewcode-back" href="../../generated/tsdst.modeling.RegressionSE.html#tsdst.modeling.RegressionSE">[docs]</a><span class="k">def</span> <span class="nf">RegressionSE</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">fit_mod</span><span class="p">,</span> <span class="n">logit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lamda</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Since sklearn doesn&#39;t generate the standard errors by default...</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : pandas dataframe</span>
<span class="sd">        The feature or design matrix.</span>
<span class="sd">    Y : pandas series or numpy array</span>
<span class="sd">        The response or target variable.</span>
<span class="sd">    fit_mod : sklearn model, or similar</span>
<span class="sd">        The fitted model (Logistic or linear Regression).</span>
<span class="sd">    logit : bool, optional</span>
<span class="sd">        If True, calculate Logistic Regression SE, otherwise, Linear. Default is True</span>
<span class="sd">    low_memory : bool, optional</span>
<span class="sd">        Sometimes this process uses a lot of memory. If True, calculate using less memory.</span>
<span class="sd">        The default is False.</span>
<span class="sd">    lamda : float, optional</span>
<span class="sd">        If performing ridge regression, this is the penalty term, lambda.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    se : numpy array</span>
<span class="sd">        The standard error of the coefficients.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cov</span><span class="p">,</span> <span class="n">XtX_inv</span><span class="p">,</span> <span class="n">sigma2</span><span class="p">,</span> <span class="n">betas</span> <span class="o">=</span> <span class="n">GenerateRegCov</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="o">=</span><span class="n">Y</span><span class="p">,</span> <span class="n">fit_mod</span><span class="o">=</span><span class="n">fit_mod</span><span class="p">,</span>
                                          <span class="n">logit</span><span class="o">=</span><span class="n">logit</span><span class="p">,</span> <span class="n">low_memory</span><span class="o">=</span><span class="n">low_memory</span><span class="p">,</span>
                                          <span class="n">lamda</span><span class="o">=</span><span class="n">lamda</span><span class="p">)</span>
    <span class="n">se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cov</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">se</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">XtX_inv</span><span class="p">,</span> <span class="n">sigma2</span><span class="p">,</span> <span class="n">betas</span></div>
  

<span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">fit_mod</span><span class="p">,</span> <span class="n">logit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="s1">&#39;prediction&#39;</span><span class="p">,</span>
            <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lamda</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">logit_transform</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">logit_se_method</span><span class="o">=</span><span class="s1">&#39;wald&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mimics predict function in R.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X_test : pandas dataframe</span>
<span class="sd">        The new values to predict.</span>
<span class="sd">    X_train : pandas dataframe</span>
<span class="sd">        The feature or design matrix (what the model was trained on).</span>
<span class="sd">    Y_train : pandas series or numpy array</span>
<span class="sd">        The response or target variable.</span>
<span class="sd">    fit_mod : sklearn model, or similar</span>
<span class="sd">        The fitted model (Logistic or linear Regression).</span>
<span class="sd">    logit : bool, optional</span>
<span class="sd">        If True, calculate Logistic Regression SE, otherwise, Linear. Default is True</span>
<span class="sd">    low_memory : bool, optional</span>
<span class="sd">        Sometimes this process uses a lot of memory. If True, calculate using less memory.</span>
<span class="sd">        The default is False.</span>
<span class="sd">    lamda : float, optional</span>
<span class="sd">        If performing ridge regression, this is the penalty term, lambda.</span>
<span class="sd">    level : float</span>
<span class="sd">        The confidence level for the prediction interval.</span>
<span class="sd">    interval : str</span>
<span class="sd">        The type of prediction, either &quot;confidence&quot; for prediction on the mean value, or</span>
<span class="sd">        &quot;prediction&quot; for interval around newly sampled values.</span>
<span class="sd">    logit_transform : bool, optional</span>
<span class="sd">        If True, perform logit transform on output. Does nothing if logit=False or</span>
<span class="sd">        method=&#39;delta&#39;. Default is False.</span>
<span class="sd">    logit_se_method : str, optional</span>
<span class="sd">        Which SE calculation method to use for logistic regression. Does nothing if</span>
<span class="sd">        logit=False. Options are wald or delta. Default is wald.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    prediction : pandas dataframe</span>
<span class="sd">        The predictions and assosiated intervals.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cov</span><span class="p">,</span> <span class="n">XtX_inv</span><span class="p">,</span> <span class="n">sigma2</span> <span class="o">=</span> <span class="n">GenerateRegCov</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y</span><span class="o">=</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">fit_mod</span><span class="o">=</span><span class="n">fit_mod</span><span class="p">,</span>
                            <span class="n">logit</span><span class="o">=</span><span class="n">logit</span><span class="p">,</span> <span class="n">low_memory</span><span class="o">=</span><span class="n">low_memory</span><span class="p">,</span>
                            <span class="n">lamda</span><span class="o">=</span><span class="n">lamda</span><span class="p">)</span>
    
    <span class="c1">#Xc_train = np.hstack([np.ones((X_train.shape[0], 1)), X_train])</span>
    <span class="n">Xc_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">X_test</span><span class="p">])</span>
    <span class="n">betas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">fit_mod</span><span class="o">.</span><span class="n">intercept_</span><span class="p">,</span> <span class="n">fit_mod</span><span class="o">.</span><span class="n">coef_</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">tstat</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">level</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">betas</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">yhat</span> <span class="o">=</span> <span class="n">Xc_test</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">betas</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">logit</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">interval</span> <span class="o">==</span> <span class="s1">&#39;prediction&#39;</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;There&#39;s generally not a meaningful definition for &quot;</span>
                          <span class="s2">&quot;a prediction interval in this case. Instead, using &quot;</span>
                          <span class="s2">&quot;the confidence interval for the mean value.&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">logit_se_method</span> <span class="o">==</span> <span class="s1">&#39;wald&#39;</span><span class="p">:</span>
            <span class="c1"># Using Wald Endpoint transformations</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">Xc_test</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Xc_test</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
            <span class="n">upper_int</span> <span class="o">=</span> <span class="n">yhat</span> <span class="o">+</span> <span class="n">tstat</span><span class="o">*</span><span class="n">se</span>
            <span class="n">lower_int</span> <span class="o">=</span> <span class="n">yhat</span> <span class="o">-</span> <span class="n">tstat</span><span class="o">*</span><span class="n">se</span>
            
            <span class="k">if</span> <span class="n">logit_transform</span><span class="p">:</span>
                <span class="n">yhat</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">yhat</span><span class="p">)</span>
                <span class="n">upper_int</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">upper_int</span><span class="p">)</span>
                <span class="n">lower_int</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">lower_int</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># TODO: fill in delta method</span>
            <span class="c1"># Using delta method</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Delta method has not been included in this&quot;</span>
                                      <span class="s2">&quot;version&quot;</span><span class="p">)</span>
            <span class="c1">#sigmoid_der(yhat).T.dot(Xc_test.T).dot(</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="n">xtXt_Xx</span> <span class="o">=</span> <span class="n">Xc_test</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">XtX_inv</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Xc_test</span><span class="p">)</span>
    
        <span class="k">if</span> <span class="n">interval</span> <span class="o">==</span> <span class="s1">&#39;prediction&#39;</span><span class="p">:</span>
            <span class="n">xtXt_Xx</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="n">upper_int</span> <span class="o">=</span> <span class="n">yhat</span> <span class="o">+</span> <span class="n">tstat</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sigma2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xtXt_Xx</span><span class="p">)</span>
        <span class="n">lower_int</span> <span class="o">=</span> <span class="n">yhat</span> <span class="o">-</span> <span class="n">tstat</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sigma2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xtXt_Xx</span><span class="p">)</span>
    
    <span class="n">prediction</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">yhat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">),</span>
                                        <span class="n">lower_int</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">),</span>
                                        <span class="n">upper_int</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">)])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                              <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;yhat&#39;</span><span class="p">,</span> <span class="s1">&#39;lower_int&#39;</span><span class="p">,</span> <span class="s1">&#39;upper_int&#39;</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="n">prediction</span>


<span class="k">def</span> <span class="nf">corrmat_validity_check</span><span class="p">(</span><span class="n">corr_mat</span><span class="p">,</span> <span class="n">corr_tol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check for perfect correlation and/or a singular covariance matrix. Either</span>
<span class="sd">    of these conditions could indicate a matrix unsuitable for Linear</span>
<span class="sd">    Regression.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    corr_mat : numpy array</span>
<span class="sd">        The correlation matrix.</span>
<span class="sd">    corr_tol : float</span>
<span class="sd">        The floating point error allowed to check for perfect correlation.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    has_perfect_corr : numpy array</span>
<span class="sd">        An array of boolean values indicating perfect correlation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">det</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">corr_mat</span><span class="p">)</span>
    <span class="n">ncols</span> <span class="o">=</span> <span class="n">corr_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">corr_mat_flat</span> <span class="o">=</span> <span class="n">corr_mat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">)</span>
    <span class="n">has_perfect_corr</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">corr_mat_flat</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="o">-</span><span class="n">corr_tol</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ncols</span><span class="p">,</span> <span class="n">ncols</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">has_perfect_corr</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">has_perfect_corr</span><span class="p">,</span> <span class="n">det</span>


<div class="viewcode-block" id="vif"><a class="viewcode-back" href="../../generated/tsdst.modeling.vif.html#tsdst.modeling.vif">[docs]</a><span class="k">def</span> <span class="nf">vif</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">corr_tol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">sing_tol</span><span class="o">=</span><span class="mf">1e-15</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate Variance Inflation Factors. The sqrt of vif indicates how many</span>
<span class="sd">    times larger the standard error is than it would be if that variable had</span>
<span class="sd">    no correlation with the other variables </span>
<span class="sd">    </span>
<span class="sd">    Assumes rows are observations and columns are variables.</span>
<span class="sd">    </span>
<span class="sd">    Expects pandas.DataFrame or numpy.array</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : pandas dataframe or numpy array</span>
<span class="sd">        The feture or design matrix.</span>
<span class="sd">    root : bool, optional</span>
<span class="sd">        Return the sqrt of the variance inflation factors. The default is False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Either pandas Dataframe or numpy array</span>
<span class="sd">        The VIFs.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">rowvar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">perfect_corr</span><span class="p">,</span> <span class="n">det</span> <span class="o">=</span> <span class="n">corrmat_validity_check</span><span class="p">(</span><span class="n">corr</span><span class="p">,</span> <span class="n">corr_tol</span><span class="o">=</span><span class="n">corr_tol</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">perfect_corr</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;There are perfectly correlated variables. VIF &quot;</span>
                      <span class="s2">&quot;may not be reliable.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">det</span> <span class="o">&lt;</span> <span class="n">sing_tol</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The corr_mat determinant is essentially zero. VIF &quot;</span>
                      <span class="s2">&quot;may not be reliable.&quot;</span><span class="p">)</span>
    
    <span class="n">vifs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">corr</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">vifs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">vifs</span><span class="p">,</span>
                            <span class="n">index</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Variance Inflation Factors&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">vifs</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Some vifs are less than one. Model is not correctly &quot;</span>
                      <span class="s2">&quot;specified or is not a suitable linear model&quot;</span><span class="p">)</span>
                      
    <span class="k">if</span> <span class="n">root</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">vifs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">vifs</span></div>


<div class="viewcode-block" id="beta_trans"><a class="viewcode-back" href="../../generated/tsdst.modeling.beta_trans.html#tsdst.modeling.beta_trans">[docs]</a><span class="k">def</span> <span class="nf">beta_trans</span><span class="p">(</span><span class="n">coef</span><span class="p">,</span> <span class="n">type_</span><span class="o">=</span><span class="s2">&quot;percent&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Transform the model coefficients in a logistic regression model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    coef : numpy array</span>
<span class="sd">        The model coefficients.</span>
<span class="sd">    type_ : str, optional</span>
<span class="sd">        The type of transform, either percent, odds, or decimal.</span>
<span class="sd">        </span>
<span class="sd">        Decimal and percent are the same, except that percent = decimal*100</span>
<span class="sd">        </span>
<span class="sd">        The default is &quot;percent&quot;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy array</span>
<span class="sd">        Transformed Coefficients.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">type_</span> <span class="o">==</span> <span class="s2">&quot;odds&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">val</span>
    <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;decimal&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">val</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">type_</span> <span class="o">==</span> <span class="s2">&quot;percent&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">100.0</span><span class="o">*</span><span class="p">(</span><span class="n">val</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">coef</span></div>
    

<div class="viewcode-block" id="getPriors"><a class="viewcode-back" href="../../generated/tsdst.modeling.getPriors.html#tsdst.modeling.getPriors">[docs]</a><span class="k">def</span> <span class="nf">getPriors</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Ycol</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate the class distributions across each column of the dataset.</span>
<span class="sd">    </span>
<span class="sd">    For classification problems, but could easily be used with regression</span>
<span class="sd">    problems if an indicator variable was made that indicated some split in the</span>
<span class="sd">    data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : pandas dataframe</span>
<span class="sd">        The feature or design matrix, along with the response variable.</span>
<span class="sd">    Ycol : str</span>
<span class="sd">        The column representing the target or response variable.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    alltab : pandas dataframe</span>
<span class="sd">        A dataframe containing all of the results.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tab</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">alltab</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1">#numeric = False</span>
    <span class="n">sub</span> <span class="o">=</span> <span class="n">data</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">sub</span><span class="p">[</span><span class="n">sub</span><span class="p">[</span><span class="n">Ycol</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
                             <span class="n">sub</span><span class="p">[</span><span class="n">sub</span><span class="p">[</span><span class="n">Ycol</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
                             <span class="n">sub</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()],</span>
                            <span class="p">[</span><span class="n">sub</span><span class="p">[</span><span class="n">sub</span><span class="p">[</span><span class="n">Ycol</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span>
                             <span class="n">sub</span><span class="p">[</span><span class="n">sub</span><span class="p">[</span><span class="n">Ycol</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span>
                             <span class="n">sub</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()]])</span>
            <span class="n">tab</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Mean&quot;</span><span class="p">,</span> <span class="s2">&quot;Std. Dev&quot;</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;All&#39;</span><span class="p">])</span>
            <span class="n">tab</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">Ycol</span>
            <span class="n">tab</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">tab</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_arrays</span><span class="p">([[</span><span class="n">tab</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">tab</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="n">tab</span><span class="o">.</span><span class="n">index</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tab</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">sub</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">Ycol</span><span class="p">],</span> <span class="n">margins</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">tab</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_arrays</span><span class="p">([[</span><span class="n">tab</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">tab</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="n">tab</span><span class="o">.</span><span class="n">index</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">alltab</span> <span class="o">=</span> <span class="n">tab</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">alltab</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">alltab</span><span class="p">,</span> <span class="n">tab</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">alltab</span></div>
    

<div class="viewcode-block" id="EstimatorSelectionHelper"><a class="viewcode-back" href="../../generated/tsdst.modeling.EstimatorSelectionHelper.html#tsdst.modeling.EstimatorSelectionHelper">[docs]</a><span class="k">class</span> <span class="nc">EstimatorSelectionHelper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A wrapper for easily grid-searching multiple models in the</span>
<span class="sd">    same run.</span>

<span class="sd">    This is adapted from David Batista, so credit goes to him.</span>

<span class="sd">    see here: https://davidsbatista.net/blog/2018/02/23/model_optimization</span>

<span class="sd">    I added some functionality that will extend to the sklearn-deap package</span>
<span class="sd">    as well. see here: https://github.com/rsteca/sklearn-deap</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="EstimatorSelectionHelper.__init__"><a class="viewcode-back" href="../../generated/tsdst.modeling.EstimatorSelectionHelper.__init__.html#tsdst.modeling.EstimatorSelectionHelper.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">searchCV</span><span class="p">,</span> <span class="n">searchCVparams</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor for the EstimatorSelectionHelper class.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        models : dict</span>
<span class="sd">            A dictionary of model types.</span>
<span class="sd">        params : dict</span>
<span class="sd">            A dictionary of parameters for each model.</span>
<span class="sd">        searchCV : sklearn object</span>
<span class="sd">            The type of search being performed.</span>
<span class="sd">        searchCVparams : dict</span>
<span class="sd">            A dictionary of optional arguments to send to searchCV.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            Raised when a model is missing parameters, or there is a mismatch.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
            <span class="n">missing_params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Some estimators are missing parameters: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">missing_params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="n">models</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keys</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid_searches</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">searchCV</span> <span class="o">=</span> <span class="n">searchCV</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">searchCVparams</span> <span class="o">=</span> <span class="n">searchCVparams</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compute_times</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gs_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span></div>
        
<div class="viewcode-block" id="EstimatorSelectionHelper.fit"><a class="viewcode-back" href="../../generated/tsdst.modeling.EstimatorSelectionHelper.fit.html#tsdst.modeling.EstimatorSelectionHelper.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        perform the search.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : pandas dataframe or numpy array</span>
<span class="sd">            The feature or design matrix.</span>
<span class="sd">        y : pandas series or numpy array</span>
<span class="sd">            The response or target variable.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self</span>
<span class="sd">            Adds fitted parameters/models to the object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">:</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">dt</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running GridSearch for </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">gs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchCV</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">searchCVparams</span><span class="p">)</span>
            <span class="n">gs</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid_searches</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">gs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute_times</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gs_name</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">return</span> <span class="bp">self</span></div>
    
    <span class="k">def</span> <span class="nf">_score_summary_ea</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sort_by</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a summary of the evolutionary algorithm results.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sort_by : list or list-like</span>
<span class="sd">            Columns to sort by, for example, &#39;mean_score&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pandas dataframe</span>
<span class="sd">            A dataframe containing the results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_searches</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_searches</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">cv_results_</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span>
            <span class="n">min_test_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_searches</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">cv_results_</span><span class="p">[</span><span class="s2">&quot;min_test_score&quot;</span><span class="p">]</span>
            <span class="n">max_test_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_searches</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">cv_results_</span><span class="p">[</span><span class="s2">&quot;max_test_score&quot;</span><span class="p">]</span>
            <span class="n">mean_test_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_searches</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">cv_results_</span><span class="p">[</span><span class="s2">&quot;mean_test_score&quot;</span><span class="p">]</span>
            <span class="n">std_test_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_searches</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">cv_results_</span><span class="p">[</span><span class="s2">&quot;std_test_score&quot;</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">min_test_score</span><span class="p">)):</span>
                <span class="n">d</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;estimator&#39;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span>
                    <span class="s1">&#39;min_score&#39;</span><span class="p">:</span> <span class="n">min_test_score</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="s1">&#39;max_score&#39;</span><span class="p">:</span> <span class="n">max_test_score</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="s1">&#39;mean_score&#39;</span><span class="p">:</span> <span class="n">mean_test_score</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="s1">&#39;std_score&#39;</span><span class="p">:</span> <span class="n">std_test_score</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="s1">&#39;all_params&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">new_row</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">({</span><span class="o">**</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">**</span><span class="n">d</span><span class="p">})</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">new_row</span><span class="p">))</span>
        
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="n">sort_by</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;estimator&#39;</span><span class="p">,</span> <span class="s1">&#39;min_score&#39;</span><span class="p">,</span> <span class="s1">&#39;mean_score&#39;</span><span class="p">,</span> <span class="s1">&#39;max_score&#39;</span><span class="p">,</span> <span class="s1">&#39;std_score&#39;</span><span class="p">]</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span> <span class="o">+</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">_score_summary_skgs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sort_by</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a summary of the Grid Search results.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sort_by : list or list-like</span>
<span class="sd">            Columns to sort by, for example, &#39;mean_score&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pandas dataframe</span>
<span class="sd">            A dataframe containing the results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">row</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">score_type</span><span class="p">):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;estimator&#39;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span>
                <span class="s1">&#39;min_score&#39;</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">scores</span><span class="p">),</span>
                <span class="s1">&#39;max_score&#39;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">scores</span><span class="p">),</span>
                <span class="s1">&#39;mean_score&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">scores</span><span class="p">),</span>
                <span class="s1">&#39;std_score&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">scores</span><span class="p">),</span>
                <span class="s1">&#39;score_type&#39;</span><span class="p">:</span> <span class="n">score_type</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">({</span><span class="o">**</span><span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">d</span><span class="p">})</span>
        
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_searches</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_searches</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">cv_results_</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">score_method_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchCVparams</span><span class="p">[</span><span class="s1">&#39;scoring&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_searches</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">cv</span><span class="p">):</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;split</span><span class="si">{}</span><span class="s2">_test_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">score_method_key</span><span class="p">)</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_searches</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">cv_results_</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>
            
                <span class="n">all_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">all_scores</span><span class="p">):</span>
                    <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">row</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">s</span> <span class="p">,</span><span class="n">p</span><span class="p">,</span> <span class="n">score_method_key</span><span class="p">)))</span>
        
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="n">sort_by</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;estimator&#39;</span><span class="p">,</span> <span class="s1">&#39;min_score&#39;</span><span class="p">,</span> <span class="s1">&#39;mean_score&#39;</span><span class="p">,</span> <span class="s1">&#39;max_score&#39;</span><span class="p">,</span> <span class="s1">&#39;std_score&#39;</span><span class="p">]</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span> <span class="o">+</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span>
    
<div class="viewcode-block" id="EstimatorSelectionHelper.score_summary"><a class="viewcode-back" href="../../generated/tsdst.modeling.EstimatorSelectionHelper.score_summary.html#tsdst.modeling.EstimatorSelectionHelper.score_summary">[docs]</a>    <span class="k">def</span> <span class="nf">score_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sort_by</span><span class="o">=</span><span class="s1">&#39;mean_score&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a summary of the scores and results.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sort_by : list or list-like</span>
<span class="sd">            Columns to sort by, for example, &#39;mean_score&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        scores : pandas dataframe</span>
<span class="sd">            A dataframe containing the results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gs_name</span> <span class="o">==</span> <span class="s1">&#39;EvolutionaryAlgorithmSearchCV&#39;</span><span class="p">:</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_score_summary_ea</span><span class="p">(</span><span class="n">sort_by</span><span class="o">=</span><span class="n">sort_by</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_score_summary_skgs</span><span class="p">(</span><span class="n">sort_by</span><span class="o">=</span><span class="n">sort_by</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">scores</span></div></div>


<span class="k">def</span> <span class="nf">BPCA_initmodel</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initialize the bPCA model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    y : numpy array</span>
<span class="sd">        The data to be nan-filled.</span>
<span class="sd">    q : int</span>
<span class="sd">        The number of dimensions to consider in the PCA.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    M : dict</span>
<span class="sd">        A dictionary of the initialized values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">M</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">M</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">M</span><span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span>
    <span class="n">M</span><span class="p">[</span><span class="s1">&#39;yest&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">M</span><span class="p">[</span><span class="s1">&#39;missidx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">M</span><span class="p">[</span><span class="s1">&#39;nomissidx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">M</span><span class="p">[</span><span class="s1">&#39;gnomiss&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">M</span><span class="p">[</span><span class="s1">&#39;gmiss&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">M</span><span class="p">[</span><span class="s1">&#39;missidx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]))[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">M</span><span class="p">[</span><span class="s1">&#39;nomissidx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]))[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">M</span><span class="p">[</span><span class="s1">&#39;missidx&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">M</span><span class="p">[</span><span class="s1">&#39;gnomiss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">M</span><span class="p">[</span><span class="s1">&#39;gmiss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">M</span><span class="p">[</span><span class="s1">&#39;yest&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="n">M</span><span class="p">[</span><span class="s1">&#39;missidx&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="c1"># ynomiss = y[M[&#39;gnomiss&#39;], :]</span>
    <span class="n">covy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="s1">&#39;yest&#39;</span><span class="p">],</span> <span class="n">rowvar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">covy</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="p">[:,</span> <span class="p">:</span><span class="n">q</span><span class="p">]</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">S</span><span class="p">[:</span><span class="n">q</span><span class="p">]</span>
    <span class="c1">#V = V.T[:, :q]</span>

    <span class="c1">#M[&#39;mu&#39;] = np.nansum(y, axis=0)/np.array([np.sum(~np.isnan(y[:, col])) for col in range(y.shape[1])])</span>
    <span class="n">M</span><span class="p">[</span><span class="s1">&#39;mu&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="c1"># W are the Principal axis vectors</span>
    <span class="n">M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">U</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">S</span><span class="p">);</span>
    <span class="n">M</span><span class="p">[</span><span class="s1">&#39;tau&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">covy</span><span class="p">))</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">S</span><span class="p">)))</span>
    <span class="n">taumax</span> <span class="o">=</span> <span class="mf">1e10</span>
    <span class="n">taumin</span> <span class="o">=</span> <span class="mf">1e-10</span>
    <span class="n">M</span><span class="p">[</span><span class="s1">&#39;tau&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="s1">&#39;tau&#39;</span><span class="p">],</span> <span class="n">taumax</span><span class="p">),</span> <span class="n">taumin</span><span class="p">)</span>
    
    <span class="n">M</span><span class="p">[</span><span class="s1">&#39;galpha0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-10</span>
    <span class="n">M</span><span class="p">[</span><span class="s1">&#39;balpha0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">M</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">M</span><span class="p">[</span><span class="s1">&#39;galpha0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">M</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="s1">&#39;tau&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]))</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">M</span><span class="p">[</span><span class="s1">&#39;galpha0&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">M</span><span class="p">[</span><span class="s1">&#39;balpha0&#39;</span><span class="p">])</span>
    
    <span class="n">M</span><span class="p">[</span><span class="s1">&#39;gmu0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.001</span>
    
    <span class="n">M</span><span class="p">[</span><span class="s1">&#39;btau0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">M</span><span class="p">[</span><span class="s1">&#39;gtau0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-10</span>
    <span class="n">M</span><span class="p">[</span><span class="s1">&#39;SigW&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">M</span>


<span class="k">def</span> <span class="nf">BPCA_dostep</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The workhorse of the bPCA algorithm, the EM-like (or Variational Bayes)</span>
<span class="sd">    step.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    M : dict</span>
<span class="sd">        A dictionary containing preliminary results for the algorithm.</span>
<span class="sd">    y : numpy array</span>
<span class="sd">        The original data.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    M : dict</span>
<span class="sd">        The updated results.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">]</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span>
    
    <span class="n">Rx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">M</span><span class="p">[</span><span class="s1">&#39;tau&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">M</span><span class="p">[</span><span class="s1">&#39;SigW&#39;</span><span class="p">]</span>
    <span class="n">Rxinv_o</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Rx</span><span class="p">)</span>

    <span class="n">idx</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="s1">&#39;gnomiss&#39;</span><span class="p">]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
    
    <span class="n">dy</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="s1">&#39;mu&#39;</span><span class="p">],</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    
    <span class="c1"># x is the factor scores</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="s1">&#39;tau&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">Rxinv_o</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dy</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="n">Tt</span> <span class="o">=</span> <span class="n">dy</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">trS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dy</span> <span class="o">*</span> <span class="n">dy</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">M</span><span class="p">[</span><span class="s1">&#39;gmiss&#39;</span><span class="p">]:</span>
        <span class="n">dyo</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">M</span><span class="p">[</span><span class="s1">&#39;nomissidx&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span> <span class="o">-</span> <span class="n">M</span><span class="p">[</span><span class="s1">&#39;mu&#39;</span><span class="p">][</span><span class="n">M</span><span class="p">[</span><span class="s1">&#39;nomissidx&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span>

        <span class="n">Wm</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">][</span><span class="n">M</span><span class="p">[</span><span class="s1">&#39;missidx&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="p">:]</span>
        <span class="n">Wo</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">][</span><span class="n">M</span><span class="p">[</span><span class="s1">&#39;nomissidx&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="p">:]</span>
        <span class="n">Rxinv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Rx</span> <span class="o">-</span> <span class="n">M</span><span class="p">[</span><span class="s1">&#39;tau&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">Wm</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Wm</span><span class="p">))</span>
        <span class="n">ex</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="s1">&#39;tau&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">Wo</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dyo</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">Rxinv</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        
        <span class="c1"># estimating data missing values</span>
        <span class="n">dym</span> <span class="o">=</span> <span class="n">Wm</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        
        <span class="n">dy</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">dy</span><span class="p">[</span><span class="n">M</span><span class="p">[</span><span class="s1">&#39;nomissidx&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">dyo</span><span class="o">.</span><span class="n">T</span>
        <span class="n">dy</span><span class="p">[</span><span class="n">M</span><span class="p">[</span><span class="s1">&#39;missidx&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">dym</span><span class="o">.</span><span class="n">T</span>
        <span class="n">M</span><span class="p">[</span><span class="s1">&#39;yest&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">dy</span> <span class="o">+</span> <span class="n">M</span><span class="p">[</span><span class="s1">&#39;mu&#39;</span><span class="p">]</span>

        <span class="n">Tt</span> <span class="o">=</span> <span class="n">Tt</span> <span class="o">+</span> <span class="n">reshape_to_vector</span><span class="p">(</span><span class="n">dy</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">reshape_to_vector</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">Tt</span><span class="p">[</span><span class="n">M</span><span class="p">[</span><span class="s1">&#39;missidx&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">Tt</span><span class="p">[</span><span class="n">M</span><span class="p">[</span><span class="s1">&#39;missidx&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">Wm</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Rxinv</span><span class="p">)</span>
        <span class="n">trS</span> <span class="o">=</span> <span class="n">trS</span> <span class="o">+</span> <span class="n">dy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dy</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="s1">&#39;missidx&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span><span class="o">/</span><span class="n">M</span><span class="p">[</span><span class="s1">&#39;tau&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">Wm</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Rxinv</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Wm</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>

    <span class="n">Tt</span> <span class="o">=</span> <span class="n">Tt</span><span class="o">/</span><span class="n">N</span>
    <span class="n">trS</span> <span class="o">=</span> <span class="n">trS</span><span class="o">/</span><span class="n">N</span>

    <span class="n">Dw</span> <span class="o">=</span> <span class="n">Rxinv_o</span> <span class="o">+</span> <span class="n">M</span><span class="p">[</span><span class="s1">&#39;tau&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">Tt</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Rxinv_o</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">N</span>
    <span class="n">Dwinv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Dw</span><span class="p">)</span>
    <span class="n">M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Tt</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Dwinv</span><span class="p">)</span>
    
    <span class="n">M</span><span class="p">[</span><span class="s1">&#39;tau&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">M</span><span class="p">[</span><span class="s1">&#39;gtau0&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">N</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">trS</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">Tt</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]))</span> <span class="o">+</span> <span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="s1">&#39;mu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="s1">&#39;mu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">M</span><span class="p">[</span><span class="s1">&#39;gmu0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">M</span><span class="p">[</span><span class="s1">&#39;gtau0&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">M</span><span class="p">[</span><span class="s1">&#39;btau0&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">N</span><span class="p">)</span>
    <span class="n">M</span><span class="p">[</span><span class="s1">&#39;SigW&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dwinv</span><span class="o">*</span><span class="p">(</span><span class="n">d</span><span class="o">/</span><span class="n">N</span><span class="p">)</span>
    
    <span class="c1"># hyperparameter alpha update</span>
    <span class="n">M</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">M</span><span class="p">[</span><span class="s1">&#39;galpha0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">d</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="s1">&#39;tau&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="s1">&#39;SigW&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">M</span><span class="p">[</span><span class="s1">&#39;galpha0&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">M</span><span class="p">[</span><span class="s1">&#39;balpha0&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">M</span>
        


<span class="c1"># assumes no rows of all NaNs</span>
<div class="viewcode-block" id="bPCA"><a class="viewcode-back" href="../../generated/tsdst.modeling.bPCA.html#tsdst.modeling.bPCA">[docs]</a><span class="k">def</span> <span class="nf">bPCA</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxepoch</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">stepsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">dtau_tol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An algorithm to compute missing values using Bayesian PCA. Translated from</span>
<span class="sd">    MATLAB code by Shigeyuki OBA, 2002 May. 5th.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : numpy array</span>
<span class="sd">        The data with missing values to be estimated.</span>
<span class="sd">    k : int, optional</span>
<span class="sd">        The number of components to consider. Must be less than the number of</span>
<span class="sd">        columns. If None, use num_cols - 1. The default is None.</span>
<span class="sd">    maxepoch : int, optional</span>
<span class="sd">        Number of iterations. The default is 200.</span>
<span class="sd">    stepsize : int, optional</span>
<span class="sd">        The number of iterations to compute before printing results.</span>
<span class="sd">        The default is 10.</span>
<span class="sd">    dtau_tol : float, optional</span>
<span class="sd">        The precision tolerance. Breaks if precision is lower than the</span>
<span class="sd">        tolerance. The default is 1e-8.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    M : dict</span>
<span class="sd">        A dictionary of the results, containing\:</span>

<span class="sd">            - yest \: The original data matrix with missing values imputed</span>
<span class="sd">            - mu \: The estimated mean row vector</span>
<span class="sd">            - W \: The estimated principal axis matrix</span>
<span class="sd">            - tau \: The estimated precision (inverse variance) of the residual \</span>
<span class="sd">                 error</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; from tsdst.modeling import bPCA</span>
<span class="sd">    &gt;&gt;&gt; X = np.array([[1,2,3],</span>
<span class="sd">    &gt;&gt;&gt;               [4,5,6],</span>
<span class="sd">    &gt;&gt;&gt;               [7,np.nan,9],</span>
<span class="sd">    &gt;&gt;&gt;               [10,11,12]])</span>
<span class="sd">    &gt;&gt;&gt;</span>
<span class="sd">    &gt;&gt;&gt; M = bPCA(X, dtau_tol=1e-6, maxepoch=1000, stepsize=10)</span>
<span class="sd">    &gt;&gt;&gt; print(M[&#39;yest&#39;])</span>
<span class="sd">    [[ 1.          2.          3.          ]</span>
<span class="sd">     [ 4.          5.          6.          ]</span>
<span class="sd">     [ 7.          7.46614942  9.          ]</span>
<span class="sd">     [ 10.         11.         12.         ]]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">N</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">d</span> <span class="o">-</span> <span class="mi">1</span>
    
    <span class="n">M</span> <span class="o">=</span> <span class="n">BPCA_initmodel</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">tauold</span> <span class="o">=</span> <span class="mi">1000</span>
    
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxepoch</span><span class="p">):</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">BPCA_dostep</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">epoch</span> <span class="o">%</span> <span class="n">stepsize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">tau</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="s1">&#39;tau&#39;</span><span class="p">];</span>
            <span class="n">dtau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">tauold</span><span class="p">));</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;epoch=</span><span class="si">%d</span><span class="s1">, dtau=</span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">dtau</span><span class="p">));</span>
            <span class="k">if</span> <span class="n">dtau</span> <span class="o">&lt;</span> <span class="n">dtau_tol</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">tauold</span> <span class="o">=</span> <span class="n">tau</span>    
    <span class="k">return</span> <span class="n">M</span></div>
        
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2020 - present, Tom Werner.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.1.2.<br/>
    </p>
  </div>
</footer>
  </body>
</html>